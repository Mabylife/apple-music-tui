# How Station in Apple Music TUI works

æœ¬æ–‡æª”èªªæ˜ Apple Music TUI ä¸­ Station æ’­æ”¾åŠŸèƒ½çš„å¯¦ä½œç´°ç¯€èˆ‡é‚è¼¯ã€‚

æœ€å¾Œæ›´æ–°ï¼š2025-11-13

## èƒŒæ™¯

Apple Music çš„ Station æ˜¯ä¸€ç¨®å‹•æ…‹ç”Ÿæˆçš„æ’­æ”¾æ¸…å–®ï¼Œæ›²ç›®æœƒæ ¹æ“šä½¿ç”¨è€…çš„å–œå¥½èˆ‡è†è½ç¿’æ…£è‡ªå‹•èª¿æ•´ã€‚é€™èˆ‡ä¸€èˆ¬çš„æ’­æ”¾æ¸…å–®ä¸åŒï¼Œå› ç‚ºä½¿ç”¨è€…ç„¡æ³•ç›´æ¥æŸ¥è©¢æˆ–æ§åˆ¶ Station ä¸­çš„å…·é«”æ›²ç›®ã€‚

åœ¨ Apple Music TUI ä¸­ï¼ŒStation ä»¥å¤–çš„æ’­æ”¾æ¸…å–®èˆ‡æ›²ç›®åˆ‡æ›å‹•ä½œéƒ½ç”± TUI è‡ªè¡Œç®¡ç†ï¼Œé€éç¶­è­·ä¸€å€‹æœ¬åœ°çš„æ’­æ”¾ä½‡åˆ— (QUEUE) ä¾†å¯¦ç¾ã€‚ç„¶è€Œï¼ŒStation çš„æ›²ç›®åˆ‡æ›å’Œæ’­æ”¾å‰‡ç”± TUI ç™¼å‡ºè«‹æ±‚çµ¦ Cider è² è²¬ï¼ŒCider æ’­æ”¾/åˆ‡æ›å®Œæˆå¾Œï¼ŒTUI å†å‘ Cider æ‹¿å–ç›®å‰æ­£åœ¨æ’­æ”¾çš„æ›²ç›®è³‡è¨Šã€‚

## æ ¸å¿ƒæ©Ÿåˆ¶

### 1. é›™é‡ ID ç®¡ç†

Station æ¨¡å¼ä½¿ç”¨å…©å€‹ä¸åŒçš„ ID ä¾†ç®¡ç†ç‹€æ…‹ï¼š

- `nowPlayingId`ï¼šå„²å­˜ Station ID

  - ç”¨é€”ï¼šåœ¨ Layer ä¸­é«˜äº®é¡¯ç¤º [Station] itemï¼ˆcyan é¡è‰²ï¼‰
  - è®“ä½¿ç”¨è€…çŸ¥é“ç›®å‰æ­£åœ¨æ’­æ”¾å“ªå€‹é›»å°

- `nowPlayingTrackInStationId`ï¼šå„²å­˜å¯¦éš›æ’­æ”¾çš„ Track ID (åªæœ‰ Station æ¨¡å¼ä¸‹ä½¿ç”¨)

  - ç”¨é€”ï¼šå‚³çµ¦ Player çµ„ä»¶ï¼Œé¡¯ç¤ºç•¶å‰æ’­æ”¾çš„æ­Œæ›²è³‡è¨Šï¼ˆæ­Œåã€è—äººã€å°ˆè¼¯å°é¢ç­‰ï¼‰
  - é€™å€‹ ID æœƒéš¨è‘—é›»å°æ’­æ”¾è€Œä¸æ–·è®ŠåŒ–

### 2. å‹•æ…‹é–å®šæ©Ÿåˆ¶

ä½¿ç”¨ `isStationOperationLocked` ç‹€æ…‹ä¾†é˜²æ­¢æ“ä½œè¡çªï¼š

- `Locked`ï¼šä»»ä½• Station æ“ä½œï¼ˆæ’­æ”¾/ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–ï¼‰éƒ½æœƒé¡¯ç¤º "Switching..." ä¸¦è¿”å›
- `Unlocked`ï¼šå¯ä»¥åŸ·è¡Œæ–°çš„æ“ä½œ

**é–å®š/è§£é–æµç¨‹**ï¼š

```
ä½¿ç”¨è€…æ“ä½œ
  â†“
æª¢æŸ¥æ˜¯å¦å·²é–å®š
  â†“ (æœªé–å®š)
ç«‹å³é–å®š
  â†“
ç™¼é€è«‹æ±‚çµ¦ Cider
  â†“
é–‹å§‹è¼ªè©¢æª¢æ¸¬åˆ‡æ›å®Œæˆ
  â†“
æª¢æ¸¬åˆ° trackId æ”¹è®Š â†’ æ›´æ–° UI â†’ è§£é–
```

### 3. æ™ºèƒ½è¼ªè©¢æª¢æ¸¬

**ç‚ºä»€éº¼éœ€è¦è¼ªè©¢ï¼Ÿ**

Cider çš„ `next/previous` API æ˜¯éé˜»å¡çš„ï¼ˆç«‹å³è¿”å›ï¼‰ï¼Œå¯¦éš›åˆ‡æ›éœ€è¦æ™‚é–“ï¼ˆç´„ 500ms-5sï¼Œå–æ±ºæ–¼ç¶²è·¯é€Ÿåº¦ï¼‰ã€‚ä½¿ç”¨å›ºå®šç­‰å¾…æ™‚é–“ä¸å¯é ï¼š

å‡å¦‚ç­‰å¾…äº”ç§’å¾Œå†å»æ‹¿ trackIdï¼š

- ç¶²è·¯å¿«ï¼šå¯èƒ½ 1 ç§’å°±å®Œæˆï¼Œä½†ç­‰ 5 ç§’æµªè²»æ™‚é–“
- ç¶²è·¯æ…¢ï¼šå¯èƒ½ 5 ç§’é‚„æ²’å®Œæˆï¼Œæ‹¿åˆ°éŒ¯èª¤çš„ trackId

**è¼ªè©¢ç­–ç•¥**ï¼š

```typescript
pollForStationTrackChange(trackIdBeforeOperation) {
  æ¯ 500ms æª¢æŸ¥ä¸€æ¬¡ï¼š
    1. æ‹¿å–ç•¶å‰ Cider çš„ trackId
    2. æ¯”è¼ƒï¼šcurrentTrackId !== trackIdBeforeOperation
       - å¦‚æœä¸åŒ â†’ åˆ‡æ›å®Œæˆï¼æ›´æ–° UIï¼Œè§£é–
       - å¦‚æœç›¸åŒ â†’ ç¹¼çºŒè¼ªè©¢
    3. è¶…é 10 ç§’ â†’ è¶…æ™‚ï¼Œå¼·åˆ¶è§£é–
}
```

**é—œéµé»**ï¼šåœ¨ç™¼é€è«‹æ±‚**ä¹‹å‰**æ•ç²ç•¶å‰çš„ trackId

```typescript
const trackIdBeforeSend = nowPlayingTrackInStationId; // æ“ä½œå‰æ•ç²
await PlayerAPI.next(); // ç™¼é€è«‹æ±‚
pollForStationTrackChange(trackIdBeforeSend); // å‚³å…¥æ•ç²çš„ ID
```

### 4. åˆå§‹åŒ–æ¸…ç†

**å•é¡Œ**ï¼šTUI å•Ÿå‹•æ™‚ï¼ŒCider å¯èƒ½å·²ç¶“åœ¨æ’­æ”¾éŸ³æ¨‚ï¼Œå°è‡´ç‹€æ…‹ä¸åŒæ­¥

**è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨ TUI åˆå§‹åŒ–æ™‚èª¿ç”¨ `PlayerAPI.stop()`

```typescript
useEffect(() => {
  PlayerAPI.stop().catch(() => {}); // æ¸…ç©º Cider æ’­æ”¾ç‹€æ…‹
  // ... å…¶ä»–åˆå§‹åŒ–
}, []);
```

**å•é¡Œ**ï¼šé€²å…¥ Station æ™‚ï¼ŒCider å¯èƒ½å·²ç¶“åœ¨æ’­æ”¾éŸ³æ¨‚ï¼Œå°è‡´ç‹€æ…‹ä¸åŒæ­¥

**è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨å¾ä¸€èˆ¬æ’­æ”¾åˆ‡æ›åˆ° Station æˆ–æ˜¯åˆ‡æ› Station æ™‚åˆå§‹åŒ–èª¿ç”¨ `PlayerAPI.stop()` ï¼ˆ### é¦–æ¬¡æ’­æ”¾ Stationï¼ˆå¾å…¶ä»–ç‹€æ…‹é€²å…¥ï¼‰ ç¯€æœ‰è©³ç´°æµç¨‹ï¼‰

é€™ç¢ºä¿ TUI å’Œ Cider éƒ½å¾ã€Œç„¡æ’­æ”¾ã€ç‹€æ…‹é–‹å§‹ï¼Œé¿å…ç‹€æ…‹è¡çªã€‚

## å®Œæ•´æ“ä½œæµç¨‹

### é¦–æ¬¡æ’­æ”¾ Stationï¼ˆå¾å…¶ä»–ç‹€æ…‹é€²å…¥ï¼‰

```
0ms:    ä½¿ç”¨è€…é¸æ“‡ [Station A]
        â†“
        æª¢æŸ¥é–å®šç‹€æ…‹ (æœªé–å®š âœ“)
        â†“
        è¨­å®š nowPlayingId = station A ID (é«˜äº® [Station])
        â†“
        æª¢æŸ¥ï¼šcurrentStationId !== station A ID
        â†’ æ˜¯ä¸åŒ Stationï¼ˆæˆ–å¾ä¸€èˆ¬æ­Œæ›²åˆ‡æ›ï¼‰
        â†“
        ğŸ”’ é–å®šæ“ä½œ
        â†“
        èª¿ç”¨ stop() æ¸…ç©º Cider æ’­æ”¾ç‹€æ…‹
        â†“
        è¨­å®š currentStationId = station A ID
        â†“
        æ¸…ç©º nowPlayingTrackInStationId = null
        â†“
        ç™¼é€æ’­æ”¾è«‹æ±‚çµ¦ Cider
        â†“
        é–‹å§‹è¼ªè©¢ (trackIdBeforeOperation = null)
        â†“
500ms:  è¼ªè©¢ #1 â†’ æ‹¿åˆ° trackId = "1234"
        â†’ currentTrackId ("1234") !== null âœ“
        â†’ è¨­å®š nowPlayingTrackInStationId = "1234"
        â†’ æ›´æ–° Player UI
        â†’ ğŸ”“ è§£é–
```

### ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–ï¼ˆåŒä¸€å€‹ Station å…§ï¼‰

```
0ms:    ä½¿ç”¨è€…æŒ‰ Ctrl+å·¦/å³
        â†“
        æª¢æŸ¥é–å®šç‹€æ…‹ (æœªé–å®š âœ“)
        â†“
        æ•ç² trackIdBeforeSend = "1234"
        â†“
        ğŸ”’ é–å®šæ“ä½œ
        â†“
        ç™¼é€ next/previous è«‹æ±‚çµ¦ Cider (ä¸èª¿ç”¨ stop)
        â†“
        é–‹å§‹è¼ªè©¢ (trackIdBeforeOperation = "1234")
        â†“
500ms:  è¼ªè©¢ #1 â†’ trackId = "1234" (é‚„æ²’è®Š)
1000ms: è¼ªè©¢ #2 â†’ trackId = "1234" (é‚„æ²’è®Š)
        â†’ é¡¯ç¤º "Switching..."
1500ms: è¼ªè©¢ #3 â†’ trackId = "5678" (è®Šäº†!)
        â†’ currentTrackId ("5678") !== "1234" âœ“
        â†’ è¨­å®š nowPlayingTrackInStationId = "5678"
        â†’ æ›´æ–° Player UI
        â†’ ğŸ”“ è§£é–
```

### åˆ‡æ›åˆ°ä¸åŒçš„ Station

```
0ms:    ç•¶å‰åœ¨ Station Aï¼Œä½¿ç”¨è€…é¸æ“‡ [Station B]
        â†“
        æª¢æŸ¥ï¼šcurrentStationId ("A") !== newStationId ("B")
        â†’ æ˜¯ä¸åŒ Station
        â†“
        èª¿ç”¨ stop() æ¸…ç©ºç‹€æ…‹
        â†“
        è¨­å®š currentStationId = "B"
        â†“
        æ¸…ç©º nowPlayingTrackInStationId = null
        â†“
        ç™¼é€æ’­æ”¾è«‹æ±‚
        â†“
        é–‹å§‹è¼ªè©¢ (trackIdBeforeOperation = null)
        â†“
        ï¼ˆåŒé¦–æ¬¡æ’­æ”¾æµç¨‹ï¼‰
```

### é€£çºŒå¿«é€Ÿæ“ä½œ

```
0ms:    ç¬¬ 1 æ¬¡æŒ‰ next â†’ é–å®š â†’ ç™¼é€è«‹æ±‚ â†’ é–‹å§‹è¼ªè©¢
100ms:  ç¬¬ 2 æ¬¡æŒ‰ next â†’ æª¢æŸ¥é–å®š (å·²é–å®š âœ—)
        â†’ é¡¯ç¤º "Switching..." ä¸¦è¿”å›
200ms:  ç¬¬ 3 æ¬¡æŒ‰ next â†’ æª¢æŸ¥é–å®š (å·²é–å®š âœ—)
        â†’ é¡¯ç¤º "Switching..." ä¸¦è¿”å›
...
1500ms: è¼ªè©¢æª¢æ¸¬åˆ°åˆ‡æ›å®Œæˆ â†’ è§£é–
        â†’ æ­¤æ™‚å¯ä»¥å†æ¬¡æ“ä½œ
```

## èˆ‡ä¸€èˆ¬æ›²ç›®çš„å·®ç•°

| ç‰¹æ€§           | ä¸€èˆ¬æ›²ç›®                      | Station                      |
| -------------- | ----------------------------- | ---------------------------- |
| ä½‡åˆ—ç®¡ç†       | TUI æœ¬åœ°ç®¡ç† (QueueService)   | Cider ç®¡ç†                   |
| nowPlayingId   | Track IDï¼ˆç”¨æ–¼é«˜äº® + Playerï¼‰ | Station IDï¼ˆåƒ…ç”¨æ–¼é«˜äº®ï¼‰     |
| ä¸Šä¸‹é¦–åˆ‡æ›     | ä½¿ç”¨è™›æ“¬ä½‡åˆ—ï¼Œ500ms debounce  | ç›´æ¥èª¿ç”¨ Cider APIï¼Œè¼ªè©¢æª¢æ¸¬ |
| è‡ªå‹•æ’­æ”¾ä¸‹ä¸€é¦– | TUI ç›£è½é€²åº¦ï¼Œè‡ªå‹•åˆ‡æ›        | Cider è‡ªå‹•è™•ç†               |
| æ“ä½œé™åˆ¶       | ç„¡                            | å‹•æ…‹é–å®šï¼Œç›´åˆ°åˆ‡æ›å®Œæˆæ‰è§£é– |
| ç‹€æ…‹æ¸…ç†       | åˆ‡æ›æ­Œæ›²æ™‚æ¸…ç©º Station ç‹€æ…‹   | åˆ‡æ› Station æ™‚èª¿ç”¨ stop()   |

## æˆåŠŸæ¢ä»¶

è¼ªè©¢æª¢æ¸¬ä¸­ï¼Œä»¥ä¸‹æƒ…æ³è¦–ç‚ºã€Œåˆ‡æ›æˆåŠŸã€ï¼š

1. **é¦–æ¬¡æ’­æ”¾**ï¼š`trackIdBeforeOperation === null` ä¸”æ‹¿åˆ°æœ‰æ•ˆçš„ `currentTrackId`
2. **åˆ‡æ›æ­Œæ›²**ï¼š`currentTrackId !== trackIdBeforeOperation`

## éŒ¯èª¤è™•ç†

1. **ç„¡æ³•å–å¾— trackId**ï¼š

   - æŒçºŒè¼ªè©¢ç›´åˆ° 10 ç§’è¶…æ™‚
   - é¡¯ç¤º "Timeout - no track info"
   - å¼·åˆ¶è§£é–

2. **åˆ‡æ›æœªå®Œæˆ**ï¼š

   - trackId ä¸€ç›´æ²’è®ŠåŒ–ï¼ŒæŒçºŒåˆ° 10 ç§’è¶…æ™‚
   - é¡¯ç¤º "Timeout - track unchanged"
   - å¼·åˆ¶è§£é–ï¼ˆä½†ä¸æ›´æ–° UIï¼Œå› ç‚ºå¯¦éš›æ²’åˆ‡æ›ï¼‰

3. **API è«‹æ±‚å¤±æ•—**ï¼š
   - é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
   - ç«‹å³è§£é–

## å„ªå‹¢

âœ… **è‡ªé©æ‡‰**ï¼šç„¡è«–ç¶²è·¯å¿«æ…¢ï¼Œéƒ½èƒ½åœ¨æœ€çŸ­æ™‚é–“å…§å®Œæˆæ“ä½œ
âœ… **ç²¾ç¢º**ï¼šæª¢æ¸¬å¯¦éš›çš„ trackId è®ŠåŒ–ï¼Œä¸ä¾è³´çŒœæ¸¬çš„å›ºå®šæ™‚é–“
âœ… **å®‰å…¨**ï¼š10 ç§’è¶…æ™‚ä¿è­·ï¼Œé˜²æ­¢æ°¸ä¹…é–å®š
âœ… **ä½¿ç”¨è€…é«”é©—**ï¼šè¦–è¦ºåé¥‹ï¼ˆ"Switching..."ï¼‰ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“ç³»çµ±æ­£åœ¨è™•ç†
âœ… **ç‹€æ…‹ä¸€è‡´æ€§**ï¼šåˆå§‹åŒ–æ¸…ç†ç¢ºä¿ TUI å’Œ Cider ç‹€æ…‹åŒæ­¥

## UI ç‰¹åˆ¥æ³¨æ„

åœ¨æ’­æ”¾ Station æ™‚ï¼Œç„¡æ³•æ›´æ”¹ S/R1/RP/A ç­‰æ’­æ”¾ç‹€æ…‹ï¼Œå› æ­¤æ‡‰è©²è¦åœ¨ Player çµ„ä»¶ä¸­éš±è—é€™äº›é¡¯ç¤ºï¼Œé¿å…ä½¿ç”¨è€…èª¤ä»¥ç‚ºå¯ä»¥æ“ä½œã€‚

**å¯¦ä½œæ–¹å¼**ï¼š

- Player çµ„ä»¶æ¥æ”¶ `isPlayingStation` prop
- ç•¶ `isPlayingStation === true` æ™‚ï¼Œ`getPlaybackModeIcons()` è¿”å›ç©ºå­—ä¸²
- é€™æ¨£ Station æ¨¡å¼ä¸‹ä¸æœƒé¡¯ç¤ºä»»ä½•æ’­æ”¾æ¨¡å¼åœ–ç¤º

```typescript
const getPlaybackModeIcons = () => {
  // Don't show playback modes when playing Station
  if (isPlayingStation) {
    return "";
  }
  // ... æ­£å¸¸çš„åœ–ç¤ºé‚è¼¯
};
```

## ç›¸é—œæª”æ¡ˆ

- `src/App.tsx`ï¼šä¸»è¦é‚è¼¯å¯¦ä½œ
  - `requestTrackChange()` - æ’­æ”¾ Station
  - `handleStationNavigation()` - ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–
  - `pollForStationTrackChange()` - è¼ªè©¢æª¢æ¸¬
- `src/services/player.ts`ï¼šCider RPC API å°è£
- `src/components/Player.tsx`ï¼šæ’­æ”¾å™¨ UI é¡¯ç¤º

## API ä½¿ç”¨

### Cider RPC API

- `POST /api/v1/playback/play-item`ï¼šæ’­æ”¾ Station
- `POST /api/v1/playback/next`ï¼šä¸‹ä¸€é¦–
- `POST /api/v1/playback/previous`ï¼šä¸Šä¸€é¦–
- `GET /api/v1/playback/now-playing`ï¼šå–å¾—ç•¶å‰æ’­æ”¾è³‡è¨Š
- `POST /api/v1/playback/stop`ï¼šåœæ­¢æ’­æ”¾ï¼ˆåˆå§‹åŒ–æ™‚ä½¿ç”¨ï¼‰

### å›å‚³æ ¼å¼

```json
{
  "status": "ok",
  "info": {
    "name": "æ­Œæ›²åç¨±",
    "artistName": "è—äººåç¨±",
    "albumName": "å°ˆè¼¯åç¨±",
    "playParams": {
      "id": "1234567890" // é€™æ˜¯æˆ‘å€‘éœ€è¦çš„ trackId
    }
  }
}
```
